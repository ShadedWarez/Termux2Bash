#!/data/data/com.termux/files/usr/bin/bash -e

# Install necessary packages
apt install axel bsdtar proot-distro proot neofetch -y

# Define variables for the rootfs
FS=kali-full
NM=Kali

# Create the directory for the Kali minimal rootfs
mkdir -p $PREFIX/var/lib/proot-distro/installed-rootfs/${FS}

# Change to the rootfs directory
cd $PREFIX/var/lib/proot-distro/installed-rootfs

# Display Kali Linux ASCII art
neofetch --ascii_distro ${NM} -L

# Download the Kali minimal rootfs using axel
axel -a -o "${FS}.tar.xz" "https://kali.download/nethunter-images/current/rootfs/kali-nethunter-rootfs-full-arm64.tar.xz"

# Extract the rootfs
echo "[*] Extracting rootfs takes 15 minutes...!!!"
proot --link2symlink bsdtar -xpJf "${FS}.tar.xz" 2>/dev/null

# Move the extracted files to the correct directory
echo "Migrating..."
mv kali-arm64/* $PREFIX/var/lib/proot-distro/installed-rootfs/${FS}

# Create a proot-distro configuration file for the Kali full rootfs
echo "Creating proot configuration file..."
cat >$PREFIX/etc/proot-distro/${FS}.sh << EOF
DISTRO_NAME="${NM} Nethunter Full"
TARBALL_URL['aarch64']="https://kali.download/nethunter-images/current/rootfs/kali-nethunter-rootfs-full-arm64.tar.xz"
TARBALL_SHA256['aarch64']="$(sha256sum "${FS}.tar.xz" | awk '{print $1}')"
EOF

# Create a shortcut command to start Kali
echo "
#!/bin/bash
proot-distro login ${FS}
" > $PREFIX/bin/${FS}
termux-fix-shebang $PREFIX/bin/${FS}
chmod 700 $PREFIX/bin/${FS}

# Add the Kali command to the bashrc for easy access
echo "
clear
${FS}
" >>$PREFIX/etc/bash.bashrc

# Clean up the temporary directory
sleep 5s
rm -rf ${RFS} ${FS}.tar.xz

echo "Successful Installation!"
# Inform the user how to login
echo -e '\e[1;96m'
echo "To login ${NM} Linux, Type: ${FS}"
echo -e '\e[0m'
