#!/data/data/com.termux/files/usr/bin/bash

# Install required packages
apt install proot bsdtar axel neofetch -y
clear

cd "$HOME"

### Set variables
TAR="kali-nethunter-rootfs-minimal-arm64.tar.xz"
DIR="kali-arm64"
NM="kali"

# Display system info
neofetch --ascii_distro Kali -L

# Download Kali rootfs
echo "[*] Downloading Kali Nethunter Rootfs..."
axel -a "https://kali.download/nethunter-images/current/rootfs/${TAR}"

# Create a proot-distro configuration file
echo " "
cat << EOF
Checking ${NM} tarball file integrity...
EOF
echo " "
cat > "$HOME/${TAR}_SHA256" << EOF
${TAR}_SHA256=$(sha256sum "${TAR}" | awk '{print $1}')
EOF
cat "$HOME/${TAR}_SHA256"

# Extract rootfs
echo " "
echo "[*] Extracting Kali Linux Rootfs..."
proot --link2symlink bsdtar -xpJf "${TAR}" 2>/dev/null

# Update bash.bashrc
cat >> "$PREFIX/etc/bash.bashrc" << EOF
${NM}
EOF

# Adding shortcut file
wget -O "$PREFIX/bin/kali" "https://raw.githubusercontent.com/xiv3r/Termux-Pentesting-Distro/refs/heads/main/KaliLinux/Chroot/kali"
termux-fix-shebang "$PREFIX/bin/${NM}"
chmod 700 "$PREFIX/bin/${NM}"

# Add uninstallation config file
cat > "$PREFIX/bin/${NM}-uninstall" << EOF
rm -rf $HOME/${DIR}
rm -rf $PREFIX/bin/${NM}
sed -i 's/${NM}//g' $PREFIX/etc/bash.bashrc
EOF
chmod 700 "$PREFIX/bin/${NM}-uninstall"

# Download configuration files
wget -O "${DIR}/home/kali/.bashrc" "https://raw.githubusercontent.com/xiv3r/Termux-Pentesting-Distro/refs/heads/main/KaliLinux/rcfiles/home.bashrc"

# Modify .bash_profile
sed -i '/if/,/fi/d' "${DIR}/root/.bash_profile"

# Set SUID for sudo and su
chmod +s "${DIR}/usr/bin/sudo"
chmod +s "${DIR}/usr/bin/su"

# Configure sudoers
echo " "
echo "[*] Configuring Sudoers..."
cat > "${DIR}/etc/sudoers.d/${NM}" << EOF
${NM}    ALL=(ALL) NOPASSWD: ALL
EOF

# Update bash.bashrc inside chroot
cat >> "${DIR}/etc/bash.bashrc" << EOF
neofetch
EOF

# Configure sudo.conf
cat > "${DIR}/etc/sudo.conf" << EOF
Set disable_coredump false
EOF

# Modify user and group IDs
USRID=$(id -u)
GRPID=$(id -g)
${NM} usermod -u "$USRID" ${NM} 2>/dev/null
${NM} groupmod -g "$GRPID" ${NM} 2>/dev/null

# Start chroot environment
echo " "
echo "[*] Starting Chroot Environment..."
bash "${NM}"

# Update kali
echo " "
echo "[*] Updating Kali Linux..."
sudo apt update
sudo apt install neofetch -y

# Display success message
echo -e '\e[1;93m'
cat << EOF
[*] Successful Installation!

To Login Kali Type: kali
EOF

# Delete tarball
sleep 5s
rm -rf "${TAR}"
rm -rf "${TAR}_SHA256"
